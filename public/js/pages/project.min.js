"use strict";const table=document.getElementById("tbl-main"),tbody=table.tBodies[0],lang=JSON.parse(document.getElementById("lang").textContent),checkAll=document.getElementById("check-all"),deleteAllBtn=document.getElementById("delete-all"),prevPage=document.getElementById("previous-page"),nextPage=document.getElementById("next-page");let selectedRows=[],data=null,fetchUrl=`${window.location.origin}/projects/get`;const getData=async(url,options)=>{try{let opt=options||{},req=await fetch(url,opt);const j=await req.json();return j}catch(err){console.error(err)}};(async()=>{document.getElementById("loading-table").classList.remove("d-none"),data=await getData(fetchUrl),await setTable(data),document.getElementById("loading-table").classList.add("d-none"),checkAll.addEventListener("click",checkAllRows),deleteAllBtn.addEventListener("click",async e=>deleteAllRows(e,{}));const frmSearch=document.forms["search-form"];frmSearch.addEventListener("submit",async e=>await filterData(e)),frmSearch.addEventListener("reset",async e=>{fetchUrl=`${window.location.origin}/projects/get`,data=await getData(fetchUrl),checkAll.checked=!1,await setTable(data)}),document.getElementById("previous-page").addEventListener("click",async e=>{null!==data.prev_page_url&&(e.target.classList.remove("disabled"),document.getElementById("loading-table").classList.remove("d-none"),data=await getData(data.prev_page_url),await setTable(data),document.getElementById("loading-table").classList.add("d-none"))}),document.getElementById("next-page").addEventListener("click",async e=>{null!==data.next_page_url&&(e.target.classList.remove("disabled"),document.getElementById("loading-table").classList.remove("d-none"),data=await getData(data.next_page_url),await setTable(data),document.getElementById("loading-table").classList.add("d-none"))})})();const setTable=async data=>{tbody.innerHTML=null,Array.from(data.data,item=>{const row=tbody.insertRow(),keys=Object.keys(item);row.dataset.id=item.id;const cell_0=row.insertCell(0);cell_0.innerHTML='<div class="form-check">'+`<input type="checkbox" class="form-check-input check-row" id="row_${item.id}" name="row[]" value="${item.id}" onclick="checkRow(event)">`+`<label for="row_${item.id}" class="form-check-label"></label>`+"</div>",cell_0.classList.add("ps-1");const cell_1=row.insertCell(1);cell_1.dataset.name="id",cell_1.innerText=item.id,cell_1.classList.add("d-none");const cell_2=row.insertCell(2);cell_2.dataset.name="project_name",cell_2.innerText=item.project_name,cell_2.classList.add("ps-1");const cell_3=row.insertCell(3);cell_3.dataset.name="customer_id",cell_3.innerText=item.customers.id,cell_3.classList.add("d-none");const cell_4=row.insertCell(4);cell_4.dataset.name="customer_name",cell_4.innerText=item.customers.customer_name,cell_4.classList.add("ps-1");const cell_5=row.insertCell(5);cell_5.innerHTML='<span class="d-flex flex-nowrap flex-grow-0 align-items-center">'+`<a type="button" class="btn btn-sm btn-info btn-circle p-0 m-0 edit_data" data-bs-toggle="tooltip" data-bs-title="Edit" href="${window.location.origin}/projects/${item.id}/edit">`+'<i class="fas fa-edit font-reset"></i></a><button type="button" class="btn btn-sm btn-danger btn-circle p-0 m-0 ms-1 delete_data" data-bs-toggle="tooltip" data-bs-title="Delete" onclick="deleteConfirmation(event)"><i class="fas fa-trash font-reset"></i></button></span>',cell_5.classList.add("ps-1")}),await setPagination(data)},setPagination=async data=>{var pageNo=document.getElementById("page_no"),totalPage=document.getElementById("total_pages");pageNo.innerText=data.current_page,totalPage.innerText=data.last_page},deleteConfirmation=e=>{const tr=e.target.parentNode.closest("tr"),props=[...tr.cells].filter(x=>x.dataset.hasOwnProperty("name")).reduce((prev,curr)=>Object.assign(prev,{[curr.dataset.name]:curr.innerHTML}),{});Swal.fire({title:'<h4 class="text-warning">'+lang.delete.confirm+"</h4>",html:'<h5 class="text-warning">'+lang.delete.text+"</h5>",icon:"warning",confirmButtonText:lang.confirmation.yes,showCancelButton:!0,cancelButtonText:lang.confirmation.no}).then(t=>{t.value&&(loading(),fetch(`${window.location.origin}/projects/${props.id}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector("meta[name='csrf-token']").content}}).then(res=>{Swal.close(),window.location.reload()}).catch(err=>{console.log(err)}))})},checkAllRows=()=>{switch(checkAll.checked){case!0:Array.from([...tbody.rows],val=>{const cb=val.getElementsByClassName("check-row")[0];cb.checked=!0,cb.disabled="disabled",val.classList.add("bg-light")}),document.getElementById("next-page").classList.add("disabled"),document.getElementById("previous-page").classList.add("disabled");break;case!1:Array.from([...tbody.rows],val=>{const cb=val.getElementsByClassName("check-row")[0];cb.checked=!1,cb.disabled=!1,val.classList.remove("bg-light")}),document.getElementById("next-page").classList.remove("disabled"),document.getElementById("previous-page").classList.remove("disabled")}},checkRow=e=>{e.stopPropagation(),e.target.checked?selectedRows.push(e.target.value):selectedRows.splice(selectedRows.indexOf(e.target.value),1)},loading=()=>{Swal.fire({html:'<div class="d-flex flex-column align-items-center"><span class="spinner-border text-primary"></span><h3 class="mt-2">Loading...</h3><div>',showConfirmButton:!1,width:"14rem"})},filterData=async e=>{e.preventDefault();let frm=new FormData(e.target),obj=Object.fromEntries(frm.entries()),params=new URLSearchParams(obj);try{fetchUrl=`${window.location.origin}/projects/get?`+params,data=await getData(fetchUrl),await setTable(data)}catch(error){console.log(error)}},tableLoading=()=>{},deleteAllRows=async(e,opt)=>{opt.method="DELETE",opt.headers={"X-CSRF-TOKEN":document.querySelector("meta[name='csrf-token']").content};let params={},uri=`${window.location.href}/truncate`;Swal.fire({title:'<h4 class="text-warning">'+lang.delete.confirm+"</h4>",html:'<h5 class="text-warning">'+lang.delete.text+"</h5>",icon:"warning",confirmButtonText:lang.confirmation.yes,showCancelButton:!0,cancelButtonText:lang.confirmation.no}).then(async t=>{if(!t.value)return;if(!checkAll.checked&&0===selectedRows.length)return;loading(),checkAll.checked?(params={},selectedRows=[],params.rows="all"):(params={},params.rows=selectedRows.join(","));const filter=Object.fromEntries(new URL(fetchUrl).searchParams.entries());filter.s_project_name&&(params.s_project_name=filter.s_project_name),filter.s_project_customer&&(params.s_project_customer=filter.s_project_customer),uri+="?"+new URLSearchParams(params),await getData(uri,opt).then(res=>{Swal.close(),window.location.reload()}).catch(err=>console.log(err))}).catch(err=>{console.log(err)})};